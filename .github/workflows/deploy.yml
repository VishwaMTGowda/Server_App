name: Deploy Static HTML to EC2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate HTML
      run: |
        if [ -f index.html ]; then
          echo "‚úÖ HTML file exists"
          # Simple HTML validation
          if grep -q "<!DOCTYPE html>" index.html; then
            echo "‚úÖ Valid HTML5 doctype found"
          else
            echo "‚ùå Invalid HTML - missing doctype"
            exit 1
          fi
        else
          echo "‚ùå No HTML file found"
          exit 1
        fi
    
    - name: Check file size
      run: |
        echo "HTML file size: $(wc -l < index.html) lines"
        echo "File size: $(du -h index.html | cut -f1)"

  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup SSH
      env:
        SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
    
    - name: Create deployment info
      run: |
        echo "Creating deployment metadata..."
        DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
        COMMIT_HASH=$(git rev-parse --short HEAD)
        
        # Create info file
        cat > deployment-info.json << EOF
        {
          "deployment_time": "$DEPLOY_TIME",
          "commit_hash": "$COMMIT_HASH",
          "branch": "main",
          "github_run_id": "${{ github.run_id }}",
          "github_run_number": "${{ github.run_number }}"
        }
        EOF
        
        # Create HTML version
        cat > deployment.html << EOF
        <!DOCTYPE html>
        <html>
        <head><title>Deployment Info</title></head>
        <body>
          <h1>Deployment Information</h1>
          <p><strong>Time:</strong> $DEPLOY_TIME</p>
          <p><strong>Commit:</strong> $COMMIT_HASH</p>
          <p><strong>GitHub Run:</strong> ${{ github.run_number }}</p>
          <p><strong>Triggered by:</strong> ${{ github.actor }}</p>
        </body>
        </html>
        EOF
        
        cat deployment-info.json
    
    - name: Deploy files to EC2
      run: |
        echo "Deploying static files to EC2..."
        
        # Sync all files to EC2
        rsync -avz --delete \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='.gitignore' \
          --exclude='node_modules' \
          --exclude='*.log' \
          -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
          ./ ubuntu@${{ secrets.EC2_HOST }}:/var/www/static-html/
    
    - name: Setup Nginx on EC2
      run: |
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          
          echo "Installing Nginx if not installed..."
          if ! command -v nginx &> /dev/null; then
            sudo apt update
            sudo apt install nginx -y
          fi
          
          echo "Creating web directory..."
          sudo mkdir -p /var/www/static-html
          sudo chown -R ubuntu:www-data /var/www/static-html
          sudo chmod -R 755 /var/www/static-html
          
          echo "Configuring Nginx..."
          cat << 'NGINX_CONFIG' | sudo tee /etc/nginx/sites-available/static-site
          server {
              listen 80;
              server_name _;
              root /var/www/static-html;
              index index.html;
              
              location / {
                  try_files \$uri \$uri/ =404;
                  add_header X-Deployed-By "GitHub Actions";
                  add_header X-Commit-Hash "$(git -C /var/www/static-html rev-parse --short HEAD 2>/dev/null || echo 'unknown')";
              }
              
              location /deployment {
                  alias /var/www/static-html/deployment.html;
              }
              
              location /info {
                  alias /var/www/static-html/deployment-info.json;
                  add_header Content-Type application/json;
              }
              
              # Security headers
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header Referrer-Policy "strict-origin-when-cross-origin" always;
          }
          NGINX_CONFIG
          
          # Enable site
          sudo ln -sf /etc/nginx/sites-available/static-site /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          
          echo "Testing Nginx configuration..."
          sudo nginx -t
          
          echo "Restarting Nginx..."
          sudo systemctl restart nginx
          
          echo "Nginx status:"
          sudo systemctl status nginx --no-pager
        EOF
    
    - name: Verify deployment
      run: |
        echo "Waiting for Nginx to restart..."
        sleep 3
        
        echo "Testing website..."
        HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}/ || echo "Failed")
        
        if [ "$HTTP_STATUS" = "200" ]; then
          echo "‚úÖ Website deployed successfully! HTTP Status: $HTTP_STATUS"
          echo "üåê Access your site at: http://${{ secrets.EC2_HOST }}"
          echo "üìä Deployment info: http://${{ secrets.EC2_HOST }}/deployment"
          echo "üîß JSON info: http://${{ secrets.EC2_HOST }}/info"
          
          # Show page title
          curl -s http://${{ secrets.EC2_HOST }} | grep -o "<title>[^<]*</title>" || true
        else
          echo "‚ö†Ô∏è  Deployment check failed. Status: $HTTP_STATUS"
          echo "Check Nginx logs on EC2: sudo journalctl -u nginx"
        fi
        